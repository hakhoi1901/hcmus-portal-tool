// ================= CONFIG.JS =================
// C√íNIG c√†i ƒë·∫∑t s·∫µn c√°c gi√° tr·ªã
// ==================================================

// L∆∞u ƒë·ªãa ch·ªâ c√°c tab kh√°c nhau c·ªßa portal
export const PORTAL_TAB_URL = {
        URL_DIEM: "https://new-portal4.hcmus.edu.vn/SinhVien.aspx?pid=211", // Trang xem ƒëi·ªÉm
        URL_LICHTHI: "/SinhVien.aspx?pid=212",                               // Trang l·ªãch thi
        URL_HOCPHI: "/SinhVien.aspx?pid=331"                                  // Trang h·ªçc ph√≠
    };

// L∆∞u ƒë·ªãa ch·ªâ portal ƒë·ªÉ m·ªü
export const PORTAL_URL = 'https://new-portal1.hcmus.edu.vn/Login.aspx?ReturnUrl=%2fSinhVien.aspx%3fpid%3d211&pid=211';

// Bookmarklet
export const bookmarkletCode = `javascript:(async function(){const URL_DIEM="https://new-portal4.hcmus.edu.vn/SinhVien.aspx?pid=211";const URL_LICHTHI="/SinhVien.aspx?pid=212";const URL_HOCPHI="/SinhVien.aspx?pid=331";if(window.location.href.indexOf("pid=211")===-1){window.location.href=URL_DIEM;return}const cb=document.getElementById("ctl00_ContentPlaceHolder1_ctl00_cboNamHoc_gvDKHPLichThi_ob_CbocboNamHoc_gvDKHPLichThiTB");const btn=document.getElementById("ctl00_ContentPlaceHolder1_ctl00_btnXemDiemThi");if(!cb||!btn){alert("‚ö†Ô∏è L·ªói giao di·ªán.");return}const isAll=(cb.value.indexOf("T·∫•t c·∫£")!==-1||cb.value.indexOf("All")!==-1);if(!isAll){try{if(typeof cboNamHoc_gvDKHPLichThi!=='undefined')cboNamHoc_gvDKHPLichThi.value('0');else throw new Error()}catch(e){console.log("Manual fallback")}btn.click();alert("üîÑ ƒêang t·∫£i l·∫°i trang l·∫•y 'T·∫•t c·∫£' ƒëi·ªÉm...\\n\\nüëâ B·∫§M L·∫†I L·∫¶N N·ªÆA SAU KHI T·∫¢I XONG!");return}function scrapeGrades(){try{let mssv="Unknown";const userEl=document.getElementById('user_tools');if(userEl){const match=userEl.innerText.match(/Xin ch√†o\\s+([^|]+)/i);if(match)mssv=match[1].trim()}const grades=[];const rows=document.querySelectorAll('#tbDiemThiGK tbody tr');rows.forEach(row=>{if(row.cells.length<6)return;const s=row.cells[1]?.innerText||'';const sc=parseFloat(row.cells[5]?.innerText||'');const id=s.match(/^([A-Z0-9]+)\\s-/);if(id&&!isNaN(sc))grades.push({id:id[1],score:sc})});return{mssv,grades}}catch(e){return null}}async function fetchBG(url,type){try{const res=await fetch(url);const text=await res.text();const doc=new DOMParser().parseFromString(text,'text/html');if(type==='EXAM'){const ex=[];doc.querySelectorAll('#tbLichThi tbody tr').forEach(row=>{if(row.cells.length>3)ex.push({sub:row.cells[1]?.innerText.trim(),date:row.cells[2]?.innerText.trim(),time:row.cells[3]?.innerText.trim(),room:row.cells[4]?.innerText.trim()})});return ex}if(type==='TUITION'){const details=[];doc.querySelectorAll('.dkhp-table tbody tr').forEach(row=>{const c=row.querySelectorAll('td');if(c.length>9){let rawName=c[2].innerText.trim();let codeMatch=rawName.match(/\\[(.*?)\\]/);let code=codeMatch?codeMatch[1]:"";let name=rawName.replace(/\\[.*?\\]/g,'').trim();if(rawName) details.push({code:code,name:name,credits:c[3].innerText.trim(),fee:c[9].innerText.trim()})}});const totalEl=doc.querySelector('th[title="T·ªïng s·ªë ph·∫£i ƒë√≥ng"]');const total=totalEl?totalEl.innerText.trim():"0";return{total:total,details:details}}return[]}catch(e){return type==='TUITION'?{total:"0",details:[]}:[]}}try{const gData=scrapeGrades();if(!gData||gData.grades.length===0){alert("‚ö†Ô∏è B·∫£ng ƒëi·ªÉm tr·ªëng.");return}const noti=document.createElement('div');noti.innerHTML='<div style="position:fixed;bottom:10px;right:10px;background:#005a8d;color:white;padding:10px;z-index:9999">‚è≥ ƒêang l·∫•y L·ªãch thi & H·ªçc ph√≠...</div>';document.body.appendChild(noti);const[exams,tuitionData]=await Promise.all([fetchBG(URL_LICHTHI,'EXAM'),fetchBG(URL_HOCPHI,'TUITION')]);document.body.removeChild(noti);const payload={mssv:gData.mssv,grades:gData.grades,exams:exams,tuition:tuitionData};if(window.opener){window.opener.postMessage({type:'PORTAL_DATA',payload:payload},'*');alert("‚úÖ XONG!\\n- Xin ch√†o: "+payload.mssv+"\\n- ƒêi·ªÉm: "+payload.grades.length+" m√¥n\\n- H·ªçc ph√≠: "+payload.tuition.total);}else{alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Web App cha.");}}catch(e){alert("‚ùå L·ªói: "+e.message)}})();`;